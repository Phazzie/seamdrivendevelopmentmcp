# MCP Collaboration Server Overview

## Purpose
Build a local MCP server that lets multiple AI agents collaborate safely by enforcing identity, locks, tasks, messages, status snapshots, and audit logging.

## Scope and Capabilities
- Agent identity is required for tool calls (register, whoami, list) and is recorded in the audit trail.
- File locking prevents conflicting edits and supports renew/list/force release.
- Tasks and messages provide coordination state shared through the store.
- Status snapshots provide a quick health/context summary.
- Audit logging records all tool calls for traceability.
- Storage is a local JSON file with optimistic concurrency control.

## Architecture at a Glance
- Tool call -> adapter -> store or filesystem -> result -> audit log.
- Every seam has a contract, fixtures, a mock, contract tests, and a real adapter.
- Fixtures are the source of truth for mocks and contract tests.

## Seams (Current)
- Store: local JSON store persistence and atomic updates.
- Locker: file lock coordination and path normalization.
- Tasks: task registry in the store.
- Messages: shared messages in the store.
- Agents: agent registry and identity enforcement.
- Status: snapshot reader.
- Audit: tool call audit log.
- Integration Snapshot: real store snapshot fixture for end-to-end validation.

## Seam-Driven Development (SDD) Summary
SDD ensures reliability by grounding contracts and mocks in real data.

1. Define seam and contract.
2. Run probe to capture fixtures.
3. Write mock + contract tests (fixtures-driven).
4. Implement adapter and run the same contract tests.
5. Only change contracts via the Contract Change Workflow.

## Core Concepts
- **Seam:** A boundary where behavior is isolated (storage, locks, tasks, messages, status, audit).
- **Contract:** Zod schema + types for a seam.
- **Probe:** Script that hits real dependencies and captures fixtures.
- **Fixture:** Real data snapshot (JSON) used by mocks and tests.

## Workflow (One Seam At A Time)
1. Plan, critique, revise, execute.
2. Probe and capture fixtures (fresh <= 2 days or document a waiver).
3. Update contracts and tests.
4. Implement fixtures-driven mocks.
5. Implement adapters and re-run the same contract tests.

## Contract Change Workflow (Required)
1. Update probe(s) to capture new behavior.
2. Re-run probe(s) to refresh fixtures.
3. Update contract schema/types to match fixtures.
4. Update contract tests to assert the new contract.
5. Update mocks/adapters to satisfy the tests.

## Fixture Freshness
- Every fixture JSON should include `captured_at`.
- Freshness window is <= 2 days unless a waiver is documented.
- Stale fixtures must be refreshed by re-running probes.

## Verification
- Compile: `npx tsc -p tsconfig.json`
- Contract tests: `node --test dist/tests/contract/<seam>.test.js`
- Fixture audit: `node dist/scripts/fixture-audit.js [--max-age-days=2] [--allow-stale]`
- Mock/fixture map: `node dist/scripts/mock-fixture-map.js`
- SDD gate: `node dist/scripts/sdd-check.js <seam> [--max-age-days=2] [--allow-stale]`

## Optional Pre-Commit Hook
- Enable: `git config core.hooksPath .githooks`
- Hook runs: `npm run sdd:check`

## Tooling
- `scripts/sdd-scaffold.ts` creates a seam skeleton (contract/probe/fixture/mock/test/adapter).
- `scripts/sdd-check.ts` validates seam completeness and fixture freshness.
- `scripts/fixture-audit.ts` reports missing/invalid `captured_at` and stale fixtures.
- `scripts/mock-fixture-map.ts` enforces that mocks reference fixtures.

## Gotchas
- Probes are excluded from `tsconfig.json`; compile them with the explicit `npx tsc probes/<seam>.probe.ts ... --esModuleInterop --skipLibCheck` command.
- Fixture freshness is enforced (<= 2 days); missing or stale `captured_at` fails `scripts/fixture-audit.ts`.
- Mocks must ignore `captured_at` fields to avoid leaking out-of-contract data.
- Message wait tests use fixture revision to exercise the wait path; fixture changes can affect timing behavior.
- Deterministic IDs are generated by counters in mocks; do not reintroduce randomness.
- Store path defaults to `~/.mcp-collaboration/store.json` unless `MCP_STORE_PATH` is set.
- If external tools write `store.json` directly, they must respect the revision/OCC flow to avoid lost updates.

## Collaboration Expectations
- One seam per iteration, no refactors outside the seam.
- Notes should include seam touched, tests run, and fixture freshness.
- Use `docs/agent-collab.md` for review notes, questions, and decisions.

## Key Files
- Operating rules: `AGENTS.md`
- Collaboration log: `docs/agent-collab.md`
- Status snapshot: `docs/STATUS.md`
- Spec: `COLLABORATION_SPEC.md`
